$(function(){function a(){function a(){var a=420;0===$("#c-region-map").length&&d3.json("data/d3/Vicinity_20171109_v5.json",function(b){var c=d3.select("#c-county-map").append("svg").attr("width",d).attr("height",a).attr("id","c-region-map"),e=c.append("g").attr("width",d).attr("height",a).attr("id","counties"),f=c.append("g").attr("width",d).attr("height",a).attr("id","cty_labels_outlines"),g=c.append("g").attr("width",d).attr("height",a).attr("id","cty_labels"),h=d3.geo.mercator().scale(1).translate([0,0]).precision(0),i=d3.geo.path().projection(h),j=i.bounds(b),k=1/Math.max((j[1][0]-j[0][0])/d,(j[1][1]-j[0][1])/a),l=[(d-k*(j[1][0]+j[0][0]))/2,(a-k*(j[1][1]+j[0][1]))/2];h.scale(k).translate(l),e.selectAll("path#c-san diego").data(b.features).enter().append("path").attr("d",i).attr("id",function(a){return"c-"+a.properties.NAME.toLowerCase()}).attr("class","county_outlines").on("mouseover",function(){var a=d3.select(this);a.transition().duration(250).style("fill-opacity","0.8"),a.style("stroke-width","5px")}).on("mouseout",function(){d3.select(this).transition().delay(5).style("stroke-width","2px").style("fill-opacity","1")}).on("click",function(){$("#c-county-prompt").hide();var a=d3.select(this).attr("id").split("-");P=a[1],O=W[P],window.location.hash="region/"+P+"/"+Q});f.selectAll("text").data(b.features).enter().append("text").attr("class","c-county-label-outline").attr("transform",function(a){return"translate("+i.centroid(a)+")"}).text(function(a){return a.properties.NAME}),g.selectAll("text").data(b.features).enter().append("text").attr("class","c-county-label").attr("transform",function(a){return"translate("+i.centroid(a)+")"}).text(function(a){return a.properties.NAME})})}function h(a){switch(a){case"region":$(".c-nav").hide();break;case"network":$(".c-nav-left").hide(),$(".c-nav-right").show(),$("#c-nav-right-label").html("Freight Centers");break;case"freight_centers":$(".c-nav-left").show(),$(".c-nav-right").show(),$("#c-nav-left-label").html("Network"),$("#c-nav-right-label").html("Domestic Trade");break;case"domestic_trade":$(".c-nav-left").show(),$(".c-nav-right").hide(),$("#c-nav-left-label").html("Freight Centers")}}function j(){var a=$("#cty-pic-slider").width()/1.38-59;$(window).width()>=992&&$("#c-county-desc").animate({"min-height":a},500),$("#c-county-desc").html(Y[P]),$("#c-map-legend").hasClass("open")&&$("#c-map-legend").trigger("click"),$("#c-region-network-map").attr("src","lib/images/county/"+P+"_map.png").attr("alt",q(P)+" County Map"),void 0===J?d3.csv("data/d3/county_network.csv",function(a){J=a,k()}):k()}function k(){for(var a=0;a<J.length;a++)if(J[a].NAME===q(P)){var b=J[a],c=a;0===parseInt(b.NAME)?$("#c-stat-highway").hide():$("#c-stat-highway").show();for(var d=0;d<X.length;d++)$(".c-data-"+X[d]).html(b[X[d]]);$(".c-image-caption").html(b.zero),$("#cty-pic-slider").removeData("flexslider"),$("#cty-pic-carousel").removeData("flexslider"),$(".c-slides").html("");for(var e=1;e<8;e++)$(".c-slides").append('<li><img src="lib/images/county/small/'+b.NAME+"/"+e+'.jpg" /></li>')}$(".loading_panel").delay(500).fadeOut("slow"),$("#c-map-legend").delay(500).fadeIn("slow"),$("#cty-pic-slider").flexslider({animation:"fade",controlNav:!1,animationLoop:!1,slideshow:!1,sync:"#cty-pic-carousel",after:function(){var a=S[$("#cty-pic-slider").data("flexslider").currentSlide];$(".c-image-caption").html(J[c][a])}}),$("#cty-pic-carousel").flexslider({animation:"slide",controlNav:!1,animationLoop:!1,slideshow:!1,itemWidth:100,itemMargin:5,asNavFor:"#cty-pic-slider"})}function l(b){P=b.length>1?decodeURIComponent(b[1]):"none",Q=b.length>1?b[2]:"region",O=W[P];var d=$('#c-steps li a[data-target="c-'+Q+'"] ');$(".c-step-current").find("svg.c-step-nav circle:first").attr("r",5),$(".c-step-current").find("svg.c-step-nav circle:nth-child(2)").attr("r",6),$(".c-step-current").toggleClass("c-step-current"),d.closest("li").toggleClass("c-step-current"),d.find("svg.c-step-nav circle:first").attr("r",8),d.find("svg.c-step-nav circle:nth-child(2)").attr("r",3),$(".c-region-tab").hide(),$("#c-"+Q).show(),$("#c-name").html(q(P)+" County"),$("#c-tab").html(U[Q]),h(Q),"region"===Q?(c=$("#c-explore-emphasis").width(),$("#c-explore-emphasis").css("width",c+"px"),R=$("#content").width(),a(),Q="network",P="none",$("#c-name").html("San Diego Region"),$("#c-explorer-block").fadeOut("slow")):"domestic_trade"===Q?($(".loading_panel").show(),r()):"network"===Q&&($(".loading_panel").show(),j())}function m(a,b,c){var d=0,e=window.setInterval(function(){a(),++d===c&&window.clearInterval(e)},b)}function n(){$("#c-county-prompt").hasClass("c-light")?$("#c-county-prompt").css("background-color","#312867").toggleClass("c-light"):$("#c-county-prompt").css("background-color","#7a6aa2").toggleClass("c-light")}function o(){m(n,250,10)}function p(a){function b(){c.style("stroke-width","0px"),c.transition().duration(1).attr("r",8),c.style("stroke-opacity",1)}var c=d3.select("#"+a).select("circle");setTimeout(b,351),c.style("stroke-width","1px"),c.transition().duration(348).attr("r",20),c.style("stroke-opacity",0)}function q(a){return"san diego"==P?a.replace(/\w\S*/g,function(a){return a.charAt(0).toUpperCase()+a.substr(1).toLowerCase()}):a.charAt(0).toUpperCase()+a.slice(1)}function r(){d3.csv("data/d3/commRegions_v2.csv",function(a){d3.csv("data/d3/totalFlowsBEA.csv",function(b){d3.csv("data/d3/commodities.csv",function(c){d3.csv("data/d3/stcc.csv",function(d){d3.json("data/d3/us_states_shapes.js",function(e){aa=a,ba=b,ca=c,da=d,ea=e,"domestic_trade"===Q&&s()})})})})})}function s(){if(R=$("#content").width(),0===$("#tradeMap").length){L="in",M="ton",N="all";var a=d3.select("#content").append("svg").attr("width",R).attr("height",530).attr("id","tradeMap"),b=a.append("g").attr("width",R).attr("height",530).attr("id","states");a.append("g").attr("width",R).attr("height",530).attr("id","metros"),a.append("g").attr("width",R).attr("height",530).attr("id","temp");var c=d3.geo.path().projection(T),d=c.bounds(ea),e=(d[1][0]-d[0][0]-15)/(R-50),f=(d[1][1]-d[0][1])/630,g=e>f?1e3/e:1e3,h=e>f?e:1;H=h>1?1/h:1,I=1/h*(d[1][0]-d[0][0])/2;var i=[I,315];T.scale(g).translate(i),b.selectAll("path").data(ea.features).enter().append("path").attr("d",c).attr("class","states_outline");for(var j=[],k=[],l=0;l<ba.length;l++)j.push(parseInt(ba[l].region_id)),k.push(parseInt(ba[l].rel_region_id));j=x(j),k=x(k),fa=x(j.concat(k)),z(fa,3),D(O,L),$(".loading_panel").fadeOut("slow"),ga=!1}else $("#metros").empty(),L="in",M="ton",N="all",z(fa,3),D(O,L),$("#radio_"+M).trigger("click"),$("#radio_"+L).trigger("click"),$("#"+N).trigger("click"),$("#comm-in").prop("checked",!0),$("#tradeDirection").html("Inbound <span class='caret'></span>"),$("#comm-ton").prop("checked",!0),$("#tradeMeasure").html("Volume <span class='caret'></span>"),$("#comm-"+M).prop("checked",!0),$(".loading_panel").fadeOut("slow")}function t(a,b,c,d){var e,f=a,g=b,h=c,i=d,j=[];for(e=0;e<ca.length;e++){var k=ca[e];k.dir===h&&parseInt(k.region)===f&&k.mode.toLowerCase()===i&&j.push(k)}v(u(j,g))}function u(a,b){return"ton"===b?a.sort(function(a,b){return b.ton-a.ton}):a.sort(function(a,b){return b.value-a.value}),a}function v(a){function b(a){var b=j(a);"ton"===M?g.push(parseInt(a.ton)):g.push(parseInt(a.value)),f.push(b)}function c(){return d3.svg.axis().scale(q).orient("bottom").ticks(5)}function d(){return"ton"===M?"thousand tons of activity":"million dollars of activity"}function e(a){return"ton"===M?numeral(C(.001*a,2)).format("0,0"):"$ "+numeral(C(1e-6*a,2)).format("0,0")}var f=[],g=[];$("#commChart").empty().html("");var h,i=["#312A6A","#323576","#35478A","#36559A","#2E5EA5","#396ab2","#4276c2","#5584c9","#6992cf","#7ca0d5"],j=function(a){var b,c=null;for(b=0;b<da.length;b++){var d=da[b];parseInt(d.stcc)===parseInt(a.stcc4)&&(c=d.name)}return c};if(a.length<10)for(h=0;h<a.length;h++)F=a[h],b(F);else for(h=0;h<10;h++)F=a[h],b(F);var k=$("#topCommoditiesChart").width(),l=305,m=275,n=(l-30)/g.length,o=d3.select("#commChart").attr("width",k).attr("height",l),p=d3.scale.quantize().domain([0,f.length]).range(i),q=d3.scale.linear().range([0,k-250]).domain([0,d3.max(g)]),r=d3.scale.linear().domain([0,f.length]).range([0,m]),s=d3.svg.axis().orient("left").scale(r).ticks(f.length).tickSize(0).tickFormat(function(a,b){return f[b]});o.append("g").attr("class","x axis").attr("transform","translate(220,"+m+")").call(c().tickSize(2).tickFormat(e)),o.append("g").attr("class","grid").attr("transform","translate(220,"+m+")").style("stroke-dasharray","1, 2").call(c().tickSize(-m,0,0).tickFormat(""));o.append("g").attr("transform","translate(220,0)").attr("id","yaxis").call(s).selectAll("text").attr("y",n/2);o.append("text").attr("class","x-label").attr("text-anchor","end").attr("x",k/2+110).attr("y",l-2).text(d),o.append("g").attr("transform","translate(220, 0)").attr("id","bars").selectAll("rect").data(g).enter().append("rect").attr("transform",function(a,b){return"translate(0, "+b*n+")"}).attr("width",0).attr("height",n-2).attr("class","barTip").style("fill",function(a,b){return p(b)}).transition().delay(function(a,b){return 100*b}).duration(400).attr("width",q).attr("val",function(a,b){return a}),$(".barTip").tipsy({gravity:"n",html:!0,title:function(){var a=this.getAttribute("val");return G="ton"===M?numeral(C(.001*a,2)).format("0,0.0")+" ktons":"$ "+numeral(C(1e-6*a,2)).format("0,0.0")+" M"}})}function w(a,b){return a-b}function x(a){a=a.sort(w);var b,c=[];for(b=0;b<a.length;b++)a[b]!==a[b-1]&&c.push(a[b]);return c}function y(a){var b,c=null;for(b=0;b<aa.length;b++){var d=aa[b];parseInt(d.id)===parseInt(a)&&(c=d)}return c}function z(a,b){var c;d3.geo.albersUsa();for(c=0;c<a.length;c++){var d=y(a[c]);if(d){var e=T([d.lon,d.lat]);d3.select("#metros").append("g").attr("transform","translate("+Math.round(e[0])+","+Math.round(e[1])+")").attr("r",b).attr("id","metro_"+d.id).attr("class","metro related").append("circle").attr("r",b);d.id}}}function A(){$(".flowBtn").attr("disabled",!1),"bucks"===P?$("#dt-county-prev").prop("disabled",!0):"philadelphia"===P?$("#dt-county-next").prop("disabled",!0):($("#dt-county-next").prop("disabled",!1),$("#dt-county-prev").prop("disabled",!1))}function B(a,b){return"ton"===b?a.sort(function(a,b){return b.ton-a.ton}):a.sort(function(a,b){return b.val-a.val}),a}function C(a,b){return Number(Math.round(a+"e"+b)+"e-"+b)}function D(a,b,c){$(".flowBtn").attr("disabled",!0),$("#tradeList").html(""),setTimeout(A,520);var d,e=B(ba,M),f=[],g=[],h=[],j=[],k=0;for(d=0;d<e.length;d++){var l=e[d];parseInt(l.region_id)===a&&l.rel_region_id!=l.region_id&&l.dir===b&&l.mode===N&&("ton"===M?f.push(parseInt(l.ton)):f.push(parseInt(l.val)))}g=d3.min(f),h=d3.max(f);var m=d3.scale.pow().exponent(.6).domain([g,h]).range([2,35*H]);d3.select("#metros .sel_primary").classed("prevSelection",!0),d3.selectAll("#metros .sel_related").classed("prevSelection",!0),d3.selectAll("#metros .metro").classed("sel_primary",!1).classed("sel_related",!1).classed("in",!1).classed("out",!1),$("svg circle").unbind("mouseenter mouseleave"),d3.select("#metro_"+a).attr("r",15).classed("sel_primary",!0).classed("prevSelection",!1).select("circle").attr("r",15);var n;for(n=0;n<e.length;n++){var o,p,q,r,s=e[n];if("ton"===M?(o=m(s.ton),q=s.ton,r=numeral(C(.001*q,2)).format("0,0.0")+" ktons"):(o=m(s.val),q=s.val,r="$ "+numeral(C(1e-6*q,2)).format("0,0.0")+" M"),parseInt(s.region_id)===a&&s.dir===b&&s.rel_region_id!=s.region_id&&s.mode===N){var u=d3.select("#metro_"+s.rel_region_id),v=y(s.rel_region_id),w=v.id,x=v.familiar_name;if(q>0){var z="<li class='list-group-item' data-id='"+w+"'><span class='badge partner-val'>"+r+"</span>"+x+"</li>";j.push(z)}u.classed("prevSelection",!1),u.classed("sel_related",!0).attr("r",o).classed(b,!0).select("circle").transition().duration(500).attr("r",o).attr("i",k).attr("val",q).attr("name",x),k++}}var D;if(j.length>0)for(i=0;i<10;i++)D=j[i],$(D).appendTo("#tradeList");else{D="<li class='list-group-item'><b>"+(P.slice(0,1).toUpperCase()+P.slice(1,P.length))+" County</b> has no domestic trade using <b>"+N+" transportation.</b></li>","air"===N&&42101===a&&(D+="<li class='list-group-item'>Air transportation through Philadelphia International Airport is captured by Delaware County.</li>"),$(D).appendTo("#tradeList")}d3.selectAll("#metros .prevSelection").classed("prevSelection",!1).attr("r",3).select("circle").transition().duration(500).attr("r",3),E(),$("svg .sel_related circle").tipsy({gravity:"n",html:!0,title:function(){var a=this.getAttribute("val"),b=this.getAttribute("name");C(a,2);return p="ton"===M?numeral(C(.001*a,2)).format("0,0.0")+" ktons":"$ "+numeral(C(1e-6*a,2)).format("0,0.0")+" M","<b>"+b+"</b><br>"+p}}),d3.selectAll(".metro circle").on("mouseover",null),d3.selectAll(".metro circle").on("mouseout",null),d3.selectAll(".sel_related circle").on("mouseover",function(a){d3.select(this).classed("active",!0)}).on("mouseout",function(a){d3.select(this).classed("active",!1)}),t(O,M,b,N)}function E(){var a=d3.selectAll("#metros .metro")[0];K.elements(a).start()}var F,G,H,I,J,K=sm.packer(),L="in",M="ton",N="all",O=42017,P="none",Q="network",R=$("#content").width(),S={0:"zero",1:"one",2:"two",3:"three",4:"four",5:"five",6:"six",7:"seven"},T=d3.geo.albersUsa().scale(900).translate([R,215]);f<992&&$("#c-region-nav").css({top:"57px",left:"-10px"});var U={region:"Overview",network:"Network",freight_centers:"Freight Centers",domestic_trade:"Domestic Trade Patterns"},V={Network:"network","Freight Centers":"freight_centers","Domestic Trade":"domestic_trade"},W={bucks:42017,burlington:34005,camden:34007,gloucester:34015,mercer:34021,chester:42029,delaware:42045,montgomery:42091,philadelphia:42101},X=["IntRouteMi","NatHwyMile","NHS","interch","freightRai","yards","portTermin","ShipCalls","centers","centerEmp","truckStop"],Y={"san diego":"San Diego is a city on the Pacific coast of California known for its beaches, parks and warm climate. Immense Balboa Park is the site of the renowned San Diego Zoo, as well as numerous art galleries, artist studios, museums and gardens. A deep harbor is home to a large active naval fleet, with the USS Midway, an aircraft-carrier-turned-museum, open to the public.",imperial:"Burlington County, New Jersey, is a powerhouse of freight activity with large doses of personal touches. The County is strategically located within the Northeastern United States megalopolis and that makes it an ideal logistics platform for Trenton, Philadelphia, North Jersey, and even New York City. At the same time, the County retains an unmistakable familial quality that springs from the steadfast commitment of key individuals and successive generations to promoting economic development and prosperity.",baja:"Bountiful in freight facilities and services, Camden County, New Jersey offers a wealth of supply chain solutions. Using strategic public-private partnerships and investments, the County has successfully re-loaded its arsenal of multi-modal freight capabilities. An earnest desire to speak the language of the customer and a watchful eye on major trade developments such as the Panama Canal expansion further accentuate the County’s global outlook and integrative spirit."};$(".loading_panel").html("").html('<div class="spin-item"><div class="item-inner"><div class="item-loader-container"><div class="la-ball-spin-clockwise la-2x"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div></div></div>'),$(".c-step-item").css("width",b+"px"),$(".c-step-line").css("width",2*b+"px").css("transform","translate("+g+"px, 0)"),$("#c-region-nav").fadeIn("slow");var Z=document.location.toString();if(Z.match("#")){var _=Z.split("#")[1].split("/");_.length>1?l(_):($("#c-region").fadeIn(),$("#c-name").html("San Diego Region"),$("#c-tab").html("Overview"),$("#c-explore-emphasis").css("width",c+"px"),a(),$("#c-explorer-block").fadeOut("slow"))}$('a[href="#"]').click(function(a){a.preventDefault()}),$(window).bind("hashchange",function(){if("region"===getLocationHash()){l(window.location.hash.substring(1).split("/"))}}),$(document.body).on("click","#c-steps li a ",function(){Q=$(this).attr("data-target").split("-")[1],"none"===P?($("#c-county-prompt").show(),o()):window.location.hash="region"===Q?"region":"region/"+P+"/"+Q}),$(document.body).on("click",".c-nav",function(){var a=$(this).find("span").text();Q=V[a],window.location.hash="region/"+P+"/"+Q}),$(document.body).on("click","#c-map-legend",function(){"closed"===$(this).attr("class")?($(this).css("width","240px").css("height","345px").css("border-radius","4px 20px 4px 4px").toggleClass("closed open"),$("#c-legend-icon i").toggleClass("dynico dynico-layers glyphicon glyphicon-minus"),$(".c-legend-list").show()):($(this).css("width","40px").css("height","40px").css("border-radius","20px").toggleClass("open closed"),$("#c-legend-icon i").toggleClass("glyphicon glyphicon-minus dynico dynico-layers"),$(".c-legend-list").hide())}),$(document.body).on("mouseover","#c-explore-emphasis",function(){$("#c-explore-emphasis").css("width",c+e+"px")}),$(document.body).on("mouseout","#c-explore-emphasis",function(){$("#c-explore-emphasis").css("width",c+"px")}),$("#c-county-prompt").on("click",function(){$("#c-county-prompt").hide()}),$("#c-steps li a svg").bind("mouseenter",function(){p($(this).parent().find("svg.c-ripple").attr("id"))}),d3.selection.prototype.moveToFront=function(){return this.each(function(){this.parentNode.appendChild(this)})};var aa,ba,ca,da,ea,fa,ga=!1;$("input[name='dir']").change(function(){L=$(this).val();var a="in"===L?"Inbound":"Outbound";D(O,L),$("#comm-"+L).prop("checked",!0),$("#tradeDirection").html(a+" <span class='caret'></span>")}),$("input[name='measure']").change(function(){M=$(this).val();var a="ton"===M?"Volume":"Value";D(O,L,"measure"),$("#comm-"+M).prop("checked",!0),$("#tradeMeasure").html(a+" <span class='caret'></span>")}),$("input[name='mode']").change(function(){N=$(this).val(),D(O,L,"measure")}),$("input[name='tradeMeasure']").change(function(){M=$(this).val(),$("#radio_"+M).trigger("click")}),$("input[name='tradeDirection']").change(function(){L=$(this).val(),$("#radio_"+L).trigger("click")}),$(".btn").mouseup(function(){$(this).blur()}),$(document.body).on("mouseover","#tradeList .list-group-item",function(){var a=$(this).attr("data-id");d3.select("#metros #metro_"+a).select("circle").classed("list_circle",!0)}),$(document.body).on("mouseout","#tradeList .list-group-item",function(){var a=$(this).attr("data-id");d3.select("#metros #metro_"+a).select("circle").classed("list_circle",!1)})}executeOnLoad("c-region-nav",a);var b,c,d,e,f=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth;f>=1200?(b=(.8333333*(f-30)-480)/5,e=100,c=.5*(.8333333*(f-30)-30)-15,d=.5*(.8333333*(f-30)-30)-15):f<1200&&f>=992?(b=(f-510)/5,e=100,c=.5*(f-60)-15,d=.5*(f-60)-15):f<992&&f>=768?(b=(f-60)/4.3,e=0,c=f-60,d=.5833333333*(f-60)-15):(b=(f-60)/4.3,e=0,c=f-60,d=f-60);var g=b/2*3+18});