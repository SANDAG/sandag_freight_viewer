$(function(){var a,b,c,d=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth;d>=1200?(a=.5833333333*(d-30)-30,b=.75*(.8333333*(d-30)-30)-40,c=.25*(d-30)-30):d<1200&&d>=992?(a=.6666666667*(d-30)-30,b=.75*(d-30)-40,c=.3333333333*(d-30)-30):d<992&&(a=d-60,b=d-120,c=d-60);var e,f,g=sm.packer(),h='<i class="glyphicon glyphicon-circle-arrow-up"></i>',i='<i class="glyphicon glyphicon-circle-arrow-right"></i>',j='<i class="glyphicon glyphicon-circle-arrow-down"></i>';d3.csv("data/d3/airport_diagram.csv",function(d){d3.csv("data/d3/airport_activity.csv",function(k){d3.json("data/d3/river_diagram.js",function(l){d3.csv("data/d3/river_labels.csv",function(m){function n(a){for(var b=0;b<a.length;b++){var c=a[b],d=y([c.lon,c.lat]);x.append("g").attr("transform","translate("+Math.round(d[0])+","+Math.round(d[1])+")").attr("class","mi-river-label").attr("r",1).append("text").attr("class","mi-river-label").attr("dy",".15em").text("Delaware River").attr("fill","#636363").attr("text-anchor","middle").attr("transform","rotate(-17)")}}function o(a,b){for(var c=0;c<a.length;c++){var d=a[c],e=y([d.lon,d.lat]),f=d3.select("#ports").append("g").attr("transform","translate("+Math.round(e[0])+","+Math.round(e[1])+")").attr("r",b).attr("id","port_"+d.port_link).attr("class",function(){return"b"===d.port_typ?"port mi-bulk-terminal":"port mi-general-terminal"});f.append("circle").attr("r",b),f.append("text").attr("class","mi-port-label").attr("text-anchor",function(){return"l"===d.dir?"end":"start"}).attr("x",function(){return"l"===d.dir?-18:18}).attr("y",0).attr("dy",".35em").text(d.port_name).call(p,100).attr("transform","rotate(65)")}d3.selectAll(".mi-two-line").each(function(){d3.select(this.parentNode).select("tspan.mi-child").attr("dy","-.25em")})}function p(a,b){a.each(function(){for(var a,c=d3.select(this),d=c.text().split(/\s+/).reverse(),e=[],f=c.attr("x"),g=c.attr("y"),h=.35,i=c.text(null).append("tspan").attr("class","mi-child").attr("x",f).attr("y",g).attr("dy",h+"em");a=d.pop();)e.push(a),i.text(e.join(" ")),i.node().getComputedTextLength()>b&&(e.pop(),i.text(e.join(" ")),e=[a],i=c.append("tspan").classed("mi-child",!1).attr("class","mi-two-line").attr("x",f).attr("y",g).attr("dy",".65em").text(a))})}function q(a){2003===a?($("#mi-vessel-icon").hide(),$("#mi-shipChange-text").hide(),$("#mi-shipChange-nd").show()):($("#mi-shipChange-nd").hide(),$("#mi-vessel-icon").show(),$("#mi-shipChange-text").show());for(var b=[],c=[],d=[],e=0,f=0,g=0;g<k.length;g++){var l=k[g];b.push(parseInt(l.calls))}for(var c=d3.min(b),d=d3.max(b),m=d3.scale.pow().exponent(.8).domain([c,d]).range([5,19]),g=0;g<k.length;g++){var n,l=k[g],o=0;if(n=m(parseInt(l.calls)),parseInt(l.year)===a&&l.calls>0){e=Number(e)+Number(l.calls);var p=d3.select("#port_"+l.link_id);p.attr("r",n).classed({"mi-no-activity":!1}).select("circle").transition().duration(500).attr("r",n).attr("i",o).attr("val",l.calls).attr("name",r(l.link_id)),o++}else if(parseInt(l.year)===a){var p=d3.select("#port_"+l.link_id);p.attr("r",4).classed({"mi-no-activity":!0}).select("circle").transition().duration(500).attr("r",4).attr("val",l.calls).attr("name",r(l.link_id))}parseInt(l.year)===a-1&&(f=Number(f)+Number(l.calls))}for(var g=0;g<k.length;g++){var l=k[g];if(parseInt(l.year)===a-1){var p=d3.select("#port_"+l.link_id);p.select("circle").attr("prev",l.calls)}}$("svg circle").unbind("mouseenter mouseleave"),$("#mi-vessel-count").html(numeral(e).format("0,0"));var q=(e-f)/f*100;$("#mi-vessel-percent").html(q.toFixed(0)+"%"),q>5?$("#mi-vessel-icon").html(h):q<-5?$("#mi-vessel-icon").html(j):$("#mi-vessel-icon").html(i),s(),d3.selectAll(".port circle").on("mouseover",null),d3.selectAll(".port circle").on("mouseout",null),d3.selectAll(".port circle").on("mouseover",function(a){d3.select(this).classed("active",!0);var b=this.getAttribute("val"),c=this.getAttribute("prev"),d=this.getAttribute("name"),e=(b-c)/c*100;isFinite(e)?$("#mi-vessel-percent").html(e.toFixed(0)+"%"):$("#mi-vessel-percent").html("&#8734;"),$("#mi-vessel-count").html(numeral(b).format("0,0")),$("#mi-vessel-title").html(d),e>5?$("#mi-vessel-icon").html(h):e<-5?$("#mi-vessel-icon").html(j):$("#mi-vessel-icon").html(i)}).on("mouseout",function(a){d3.select(this).classed("active",!1),$("#mi-vessel-count").html(numeral(e).format("0,0")),$("#mi-vessel-percent").html(q.toFixed(0)+"%"),$("#mi-vessel-title").html("All DVRPC Terminals"),q>5?$("#mi-vessel-icon").html(h):q<-5?$("#mi-vessel-icon").html(j):$("#mi-vessel-icon").html(i)}),d3.selectAll(".port text").on("mouseover",function(a){var b=$(this).parent().children("circle");b.toggleClass("active");var c=b.attr("val"),d=b.attr("prev"),e=b.attr("name"),f=(c-d)/d*100;isFinite(f)?$("#mi-vessel-percent").html(f.toFixed(0)+"%"):$("#mi-vessel-percent").html("&#8734;"),$("#mi-vessel-count").html(numeral(c).format("0,0")),$("#mi-vessel-title").html(e),f>5?$("#mi-vessel-icon").html(h):f<-5?$("#mi-vessel-icon").html(j):$("#mi-vessel-icon").html(i)}).on("mouseout",function(a){$(this).parent().children("circle").toggleClass("active"),$("#mi-vessel-count").html(numeral(e).format("0,0")),$("#mi-vessel-percent").html(q.toFixed(0)+"%"),$("#mi-vessel-title").html("All DVRPC Terminals"),q>5?$("#mi-vessel-icon").html(h):q<-5?$("#mi-vessel-icon").html(j):$("#mi-vessel-icon").html(i)})}function r(a){for(var b=0;b<d.length;b++){var c=d[b];if(c.port_link===a)return c.port_name}}function s(){var a=d3.selectAll("#ports .port")[0];g.elements(a).start()}function t(a){return 1e-6*a+" M"}function u(a){return.001*a+" k"}var v=$("#mi-port-diagram-wrapper").height()+30,w=d3.select("#mi-port-diagram").append("svg").attr("width",a).attr("height",v).attr("id","port_map"),x=w.append("g").attr("width",a).attr("height",v).attr("id","mi_river");w.append("g").attr("width",a).attr("height",v).attr("id","ports");var y=d3.geo.mercator().scale(1).translate([0,0]).precision(0).rotate([0,-10,0]),z=d3.geo.path().projection(y),A=z.bounds(l),B=1.12/Math.max((A[1][0]-A[0][0])/a,(A[1][1]-A[0][1])/v),C=[(a-200-B*(A[1][0]+A[0][0]))/2,(v-90-B*(A[1][1]+A[0][1]))/2];y.scale(B).translate(C),x.selectAll("path").data(l.features).enter().append("path").attr("d",z),n(m),o(d,3);var D={top:20,right:55,bottom:30,left:60},E=b-D.left-D.right,F=200-D.top-D.bottom,G=d3.time.format("%Y").parse,H=d3.bisector(function(a){return a.year}).right,I=d3.time.scale().range([0,E]),J=d3.scale.linear().rangeRound([F,0]),K=d3.scale.linear().rangeRound([F,0]),L=d3.layout.stack().offset("zero").values(function(a){return a.values}).x(function(a){return I(a.label)}).y(function(a){return a.value}),M=d3.svg.area().interpolate("cardinal").x(function(a){return I(a.label)}).y0(function(a){return J(a.y0)}).y1(function(a){return J(a.y0+a.y)}),N=d3.scale.ordinal().range(["#7ca0d5","#396ab2","#312A6A"]),O=d3.select("#maritimeTradeChart").append("svg").attr("width",E+D.left+D.right).attr("height",F+D.top+D.bottom).append("g").attr("transform","translate("+D.left+","+D.top+")");d3.csv("data/d3/maritimeIndicators.csv",function(a){function b(){var b=I.invert(d3.mouse(this)[0]);if(b.getMonth()>5)var c=b.getFullYear()+1;else var c=b.getFullYear();var d=H(a,c,1),e=[c.toString(),d-2];D.transition().duration(50).attr("transform",function(a){var b,d=n[0].values[e[1]].value,f=n[1].values[e[1]].value,g=n[2].values[e[1]].value;switch(a.name){case"swt_import":b=a.values[e[1]].value+d;break;case"domestic":b=a.values[e[1]].value+f+d;break;default:b=a.values[e[1]].value}return $(".mi-dw-year").html(c),$(".mi-dw-domestic").html((1e-6*g).toFixed(2)),$(".mi-dw-import").html((1e-6*f).toFixed(2)),$(".mi-dw-export").html((1e-6*d).toFixed(2)),"translate("+I(G(e[0]))+","+J(b)+")"}),P.transition().duration(50).attr("transform",function(a){return $(".mi-dw-containers").html((.001*p[e[1]].value).toFixed(0)),"translate("+I(G(e[0]))+","+K(p[e[1]].value)+")"}),C.transition().duration(50).attr("x1",I(G(e[0]))).attr("x2",I(G(e[0]))),I(G(e[0]))>E/2?Q.transition().duration(50).style("left",I(G(e[0]))-115+"px"):Q.transition().duration(50).style("left",I(G(e[0]))+95+"px")}function d(a,b){return a<0&&b<0?a>b?-(b-a):a-b:a<0&&b>0?-(b-a):a>b?a-b:b-a}function g(a){return"change"}var k="year",l=new Date,m=(l.getFullYear(),["swt_export","swt_import","domestic"]);N.domain(m);var n=[],o={},p=[];m.forEach(function(a){o[a]={name:a,values:[]},n.push(o[a])}),completeData=a.filter(function(a){return""!==a.domestic&&""!==a.cont_teu});var r=d3.max(a,function(a){return a.year});e=r,$("#mi-year-select").html(e+' <span class="caret"></span>');for(var s=2006;s<=r;s++)$("#maritime-year-dropdown").append('<li><input type="radio" id="m'+s+'" class="miYear" name="miYear" value="'+s+'"><label for="m'+s+'">'+s+"</label></li>");$("#m"+(r-1)).prop("checked",!0),completeData.map(function(a){a.year>2002&&(m.map(function(b){o[b].values.push({label:G(a[k]),value:+a[b]})}),p.push({year:G(a.year),value:+a.cont_teu}))});var v=d3.min(n,function(a){return d3.min(a.values,function(a){return a.label})}),w=d3.max(n,function(a){return d3.max(a.values,function(a){return a.label})});$("#mi-trade-date-min").html(v.getFullYear()),$("#mi-trade-date-max").html(w.getFullYear()),I.domain([v,w]),L(n),J.domain([0,d3.max(n,function(a){return d3.max(a.values,function(a){return a.y0+a.y})})]),K.domain([0,d3.max(p,function(a){return Math.max(a.value)})]),O.selectAll(".series").data(n).enter().append("g").attr("class","series").append("path").attr("class","streamPath").attr("d",function(a){return M(a.values)}).style("fill",function(a){return N(a.name)}).style("stroke","white");var x=d3.svg.line().interpolate("cardinal").x(function(a){return I(a.year)}).y(function(a){return K(a.value)});O.append("path").attr("d",x(p)).attr("stroke","#EAA51B").attr("fill","none").attr("stroke-width",2);var y=d3.svg.axis().scale(I).orient("bottom"),z=d3.svg.axis().scale(J).ticks(5).tickFormat(t).orient("left"),A=d3.svg.axis().scale(K).tickFormat(u).ticks(6).orient("right");O.append("g").attr("class","x axis").attr("transform","translate(0,"+F+")").call(y),O.append("g").attr("class","y axis").call(z).append("text").attr("y",-55).attr("dy",".71em").attr("x",-F/2).attr("transform","rotate(-90)").style("text-anchor","middle").text("tons of trade"),O.append("g").attr("class","y0 axis").attr("transform","translate("+E+",0)").call(A).append("text").attr("y",45).attr("dy",".71em").attr("x",-F/2).attr("transform","rotate(-90)").style("text-anchor","middle").text("TEUs of containerized cargo");var B=O.append("g").attr("class","focus").style("display","none").attr("x1",100).attr("x2",100),C=B.append("line").attr("class","mouseLine").attr("stroke-dasharray","2,2").attr("stroke-linecap","round").style("stroke","#efefef").style("stroke-width","1px").attr("x1",10).attr("x2",10).attr("y1",0).attr("y2",F),D=B.selectAll(".circle").data(n).enter().append("circle").attr("class","circle").attr("r",6).attr("fill",function(a){return N(a.name)}).attr("stroke","#fff").attr("transform",function(a){return"translate(0,"+J(a.values[0].y)+")"}),P=B.selectAll(".containerCircle").data(p).enter().append("circle").attr("class","containerCircle").attr("r",6).attr("fill","#EAA51B").attr("stroke","#fff"),Q=d3.select("#maritimeTradeChart").append("div").attr("class","mi-data-window panel panel-primary");Q.append("div").html('<div class="mi-dw-title">Trade for <span class="mi-dw-year">2014</span></div><div class=""><div class="mi-data-swatch dkblue-bg"></div> Domestic: <span class="right_align"><span class="mi-dw-domestic">xxx</span> M tons</span></div><div class=""><div class="mi-data-swatch blue-bg"></div>Imports: <span class="right_align"><span class="mi-dw-import">xxx</span> M tons</span></div><div class=""><div class="mi-data-swatch ltblue-bg"></div>Exports: <span class="right_align"><span class="mi-dw-export">xxx</span> M tons</span></div><div class="mi-data-swatch orange-bg"></div>Containers: <span class="right_align"><span class="mi-dw-containers">xxx</span> k TEUs</span></div>'),O.append("svg:rect").attr("class","overlay").attr("width",E).attr("height",F).on("mouseover",function(){B.style("display",null),Q.style("display","block")}).on("mouseout",function(){B.style("display","none"),Q.style("display","none")}).on("mousemove",b),f=function(b){0===b?($(".mi-data").hide(),$(".mi-no-data").show()):($(".mi-no-data").hide(),$(".mi-data").show()),$("#mi-export-graph").html(""),$("#mi-container-graph").html(""),$(".mi-activity-year").html(b);var e=b-2002;if(""!==a[e].port_rank)var f=a[e].port_rank,k=a[e-1].port_rank,l=f-k,m=parseInt(a[e].swt_import)+parseInt(a[e].swt_export)+parseInt(a[e].domestic),n=numeral(1e-6*m).format("0,0.0")+" M",o=parseInt(a[e-1].swt_import)+parseInt(a[e-1].swt_export)+parseInt(a[e-1].domestic),p=((m-o)/o*100).toFixed(1),q=((parseInt(a[e].nation_tot)-parseInt(a[e-1].nation_tot))/parseInt(a[e-1].nation_tot)*100).toFixed(1),r=d(p,q),s=a[e].foreign_val,t="$"+numeral(1e-9*s).format("0,0")+" B",u=a[e-1].foreign_val,v=(s-u)/u*100,w=(a[e].us_foreign-a[e-1].us_foreign)/a[e-1].us_foreign*100,x=d(v,w),y=parseInt(a[e].swt_export)/(parseInt(a[e].swt_export)+parseInt(a[e].swt_import))*100,z=[y,100-y],A=(parseInt(a[e-1].swt_export),parseInt(a[e-1].swt_export),parseInt(a[e-1].swt_import),(parseInt(a[e].swt_export)-parseInt(a[e-1].swt_export))/parseInt(a[e-1].swt_export)*100),B=(parseInt(a[e].us_export)-parseInt(a[e-1].us_export))/parseInt(a[e-1].us_export)*100,C=1e-6*parseInt(a[e].swt_export),D=d(A,B),E=parseInt(a[e].swt_cont_tons)/(parseInt(a[e].swt_export)+parseInt(a[e].swt_import))*100,F=[E,100-E],G=parseInt(a[e-1].swt_cont_tons)/(parseInt(a[e-1].swt_export)+parseInt(a[e-1].swt_import))*100,H=(E-G)/G*100;$("#mi-rank-value").html(f),l<0?$("#mi-rank-icon").html(h):l>0?$("#mi-rank-icon").html(j):$("#mi-rank-icon").html(i),$("#mi-regional").html(p+"%"),$("#mi-national").html(q+"%"),$("#mi-total-trade-value").html(n),r<-5?$("#mi-total-icon").html(j):r>5?$("#mi-total-icon").html(h):$("#mi-total-icon").html(i),$("#mi-foreign-value").html(t),$("#mi-foreign-percent").html(v.toFixed(1)+"%"),$("#mi-foreign-national").html(w.toFixed(1)+"%"),x>5?$("#mi-foreign-icon").html(h):x<-5?$("#mi-foreign-icon").html(j):$("#mi-foreign-icon").html(i);var I=33.5,J=(.05*c).toFixed(0);if(c>280){$("#mi-export-percent").css("left",Number(103)+Number(J)+"px"),$("#mi-export-overlay").css("background",'url("images/mi_export_overlay.png") no-repeat;').css("left",Number(15)+Number(J)+"px"),$("#mi-export-info-label").css("left",Number(190)+Number(J)+"px");var K=d3.scale.ordinal().range(["#EAA51B","#fff"]),L=K.domain(z),M=(K.domain(F),d3.select("#mi-export-graph").append("svg").attr("width",c).attr("height",108).append("g").attr("transform","translate("+(Number(46)+Number(J))+",54)")),N=(d3.select("#mi-container-graph").append("svg").attr("width",c).attr("height",108).append("g").attr("transform","translate("+c/2+",54)"),d3.svg.arc().outerRadius(I).startAngle(function(a){return a.startAngle+Math.PI}).endAngle(function(a){return a.endAngle+Math.PI})),O=(d3.svg.arc().innerRadius(I-15).outerRadius(I).startAngle(function(a){return Math.PI-a.startAngle}).endAngle(function(a){return Math.PI-a.endAngle}),d3.layout.pie().value(function(a,b){return a}).sort(null));M.selectAll("path").data(O(z)).enter().append("path").attr("d",N).attr("fill",function(a,b){return L(a.value)}),d3.select("#mi-export-graph").append("div").attr("id","mi-export-label").style("top","21.5px")}else $("#mi-export-percent").css("left",Number(28)+Number(.5*J)+"px"),$("#mi-export-overlay").css("background",'url("lib/images/mi_export_overlay-sm.png") no-repeat').css("left",Number(20)+Number(.5*J)+"px"),$("#mi-export-info-label").css("left",Number(120)+Number(.45*J)+"px");c>280&&c<300&&($("#mi-export-percent").css("left","103px"),$("#mi-export-overlay").css("left","15px"),$("#mi-export-info-label").css("left","180px"),$("#mi-export-graph").css("transform","translate(-15px,0)")),$("#mi-export-percent").css("display","block"),$("#mi-export-overlay").css("display","block"),$("#mi-export-info-label").css("display","block"),$("#mi-export-change").html(A.toFixed(1)+"%"),$("#mi-export-percent").html(y.toFixed(0)+"%"),$("#mi-export-national").html(B.toFixed(1)+"%"),$("#mi-export-value").html(C.toFixed(1)+" M"),$("#mi-export-indicator").html(g(A)),D>5?$("#mi-export-icon").html(h):D<-5?$("#mi-export-icon").html(j):$("#mi-export-icon").html(i),$("#mi-container-percent").html(H.toFixed(0)+"%"),$("#mi-container-indicator").html(g(H)),H>3?$("#mi-container-icon").html(h):H<-3?$("#mi-container-icon").html(j):$("#mi-container-icon").html(i)},f(e),q(e);var R=e;$("#maritime-year-dropdown").on("change","input",function(){R=parseInt($(this).val());var a=document.getElementById("m"+(R-1));f(R),q(R),a?w?($("#mi-year-prev").prop("disabled",!1),$("#mi-year-next").prop("disabled",!1)):$("#mi-year-next").prop("disabled",!0):$("#mi-year-prev").prop("disabled",!0)}),$("#mi-year-prev").on("click",function(){$("#m"+(R-1)).trigger("click")}),$("#mi-year-next").on("click",function(){$("#m"+(R+1)).trigger("click")}),$(".btn").mouseup(function(){$(this).blur()})})})})})})});